---
title: "2 speciations allowed"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(emphasis)
```


The marginal probability for two speciation allowed corresponds to 


\begin{equation}

P(y=T |\theta) = e^{-2\lambda T} + 6h_1(y=T,s(\tau_3,\theta)) + 72h_2(y=T,s(\tau_1,\theta)) + 36h_2(y=T,s(\tau_2,\theta))

\end{equation}

where  $\tau_1 = (1,1,0,0), \tau_2 = (1,0,1,0)$ and $\tau_3 = (1,0)$ and 

\begin{equation}

h_1(x=T,\theta) = \displaystyle\int_0^{T}\displaystyle\int_0^{T-t_1} \mu \lambda e^{-s_1t_1-s_2t_2-s_3(T-t_1-t_2)} dt_2 dt_1 

\end{equation}

and 

\begin{equation}

h_2(y=CT,\theta) = \displaystyle\int_0^{T}\displaystyle\int_0^{T-t_1} \displaystyle\int_0^{T-t_1-t_2}\displaystyle\int_0^{T-t_1-t_2-t_3} (\mu \lambda)^2 e^{-s_1t_1-s_2t_2-s_3t_3-s_4t_4} dt_4dt_3dt_2 dt_1 

\end{equation}

That is 

\begin{equation}

h_1(y=CT,s(\tau,\theta)) = (\mu\lambda)\left(\frac{e^{-s_2T}}{(s_3-s_2)(s_2-s_1)}\left( e^{(s_2-s_1)T}-1 \right) - \frac{e^{-s_3T}}{(s_3-s_2)(s_3-s_1)}\left( e^{(s_3-s_1)T}-1 \right)) 

\end{equation}


and
\begin{equation}
\begin{split}
h_2(y=CT,s(\tau,\theta)) = (\mu\lambda)^2(& -\frac{e^{-s_2T}}{s_4(s_4-s_3)(s_3-s_2)(s_2-s_1)}(e^{T(s_2-s_1)}-1) \\
 &+\frac{e^{-s_3T}}{s_4(s_4-s_3)(s_3-s_2)(s_3-s_1)}(e^{T(s_3-s_1)}-1)\\
  &+\frac{e^{-s_2T}}{s_4(s_4-s_3)(s_4-s_2)(s_2-s_1)}(e^{T(s_2-s_1)}-1)\\
   &-\frac{e^{-s_4T}}{s_4(s_4-s_3)(s_4-s_2)(s_4-s_1)}(e^{T(s_4-s_1)}-1)\\
    &-\frac{e^{-s_2T}}{s_4s_3(s_3-s_2)(s_2-s_1)}(e^{T(s_2-s_1)}-1)\\
     &+\frac{e^{-s_3T}}{s_4s_3(s_3-s_2)(s_3-s_1)}(e^{T(s_3-s_1)}-1)\\
      &-\frac{e^{-s_2T}}{s_4s_3(s_3-s_2)(s_2-s_1)}(e^{T(s_2-s_1)}-1)\\
       &-\frac{1}{s_4s_3s_2s_1}(e^{-s_1T}-1) \}
\end{split}
\end{equation}

note also that if $\tau_1 = (1,1,0,0), \tau_2 = (1,0,1,0)$ and $\tau_3 = (1,0)$ then $s(\tau_1,\theta) = c(2\lambda,3(\lambda+\mu),4\mu,3\mu), s(\tau_2,\theta) = c(2\lambda,3(\lambda+\mu),2\lambda,3\mu), s(\tau_1,\theta) = c(2\lambda,3(\lambda+\mu),2\lambda)$ 

```{r}
h2 <- function(s,CT){
  v1 = c(-1,1,1,-1,-1,1,-1,-1)
  v21 = c(s[2],s[3],s[2],s[4],s[2],s[3],s[2],0)
  v2 = exp(-v21*CT)
  v3 = s[4]*c(rep(s[4]-s[3],4),rep(s[3],4))*c(s[3]-s[2],s[3]-s[2],s[4]-s[2],s[4]-s[2],s[3]-s[2],s[3]-s[2],s[2],s[2])
  v4 = ifelse((v21-s[1])!=0, exp(CT*(v21-s[1]))/(v21-s[1]),CT)
  out = (v1*v2*v4)/v3
  return(out)
}
```


```{r}
h1 <- function(s,CT){
  out = (exp(-s[3]*CT)/(s[3]-s[2])) * ( (exp(CT*(s[3]-s[2]))/(s[2]-s[1]))*(exp(CT*(s[2]-s[1]))-1) +
                              - (1/(s[3]-s[1]))*(exp(CT*(s[3]-s[1]))-1) )
  if(s[1]==s[3]){
    out = (exp(-s[3]*CT)/(s[3]-s[2])) * ( (exp(CT*(s[3]-s[2]))/(s[2]-s[1]))*(exp(CT*(s[2]-s[1]))-1)  - CT )
                                           
  }
  return(out)
}

f.marg2S <- function(CT,lambda,mu){
  s1 = c(2,3,4,3)*c(lambda,lambda+mu,mu,mu)
  s2 = c(2,3,2,3)*c(lambda,lambda+mu,lambda,mu)
  s3 = c(2,3,2)*c(lambda,lambda+mu,lambda)
  out = h2(s1,CT)*72*(lambda*mu)^2+h2(s2,CT)*36*(lambda*mu)^2+h1(s3,CT)*6*lambda*mu+exp(-CT*2*lambda)
  return(out)
}

```

other functions we need 

```{r}
# DAA
g.sim <- function(x.obs,n=NULL,M){
  if (is.vector(x.obs)){
    x.obs <- matrix(rep(x.obs,each=n),ncol=length(x.obs))
  }
  n <- nrow(x.obs)
  brts <- matrix(nrow=n,ncol=2*M+1)
  to <- matrix(nrow=n,ncol=2*M+1)
  t.ext <- matrix(nrow=n,ncol=2*M+1)
  for (i in 1:n){
    wt = no.na(diff(c(0,x.obs[i,])))
    cs = length(wt)-1 # current speciations
    pm = M - cs  # possible speciations
    if(pm > 0 ){
      df = sim.extinct.truncdim(cumsum(wt),pm)
      brts[i,1:length(df$bt)] = df$bt
      to[i,1:length(df$to)] = df$to
      t.ext[i,1:length(df$to)] = df$t.ext
    }else{
      brts[i,1:length(wt)] = cumsum(wt)
      to[i,1:(length(wt))] = c(rep(2,(length(wt)-1)),2)
      t.ext[i,1:(length(wt))] = c(rep(Inf,(length(wt)-1)),Inf)
    }
  }
  return(list(brts=brts,to=to,t.ext=t.ext))
}

sim.extinct.truncdim <- function(brts,M){
  brts = no.na(brts)
  R = M - (length(brts)-1) # maximum possible number of extinctions
  Ne = sample((0:R),1)
  ms = runif(Ne,min=0,max=brts[1])
  me = runif(Ne,min=ms,max=brts[1])
  to = c(rep(1,Ne),rep(0,Ne))
  df = data.frame(bt = c(ms,me),bte=c(me,rep(Inf,Ne)),to=to)
  df = rbind(df,data.frame(bt=brts,to=rep(2,length(brts)),bte=rep(Inf,length(brts))))
  df = df[order(df$bt),]
  df$t.ext = df$bte-df$bt
  return(df)
}

# sampling probability 
g <- function(x,M){
  ans<-NULL
  n<-nrow(x$brts)
  for (i in 1:n){
    df = data.frame(bt=no.na(x$brts[i,]),bte=no.na(x$t.ext[i,]),to=no.na(x$to[i,]),t.ext=no.na(x$t.ext[i,])-no.na(x$brts[i,]))
    ans[i] = g_samp(df,M)
  }
  return(ans)
}

g_samp <- function(df,M){
  last = dim(df)[1]
  ct = df[last,1]
  Ng = sum(df$to==2) - 1 # number of observed speciations (or given data)
  R = M - Ng
  subdf = df[df$to==1,]
  ms = dim(subdf)[1]
  Ts = ct-subdf$bt
  tempto = df$to
  to = df$to[-last]
  to[to==2] = 1
  n = c(2,2+cumsum(to)+cumsum(to-1))
  n = n[tempto==1 | tempto==0]
  if(R==0){
    log_dens = 0
  }else{
    log_dens = - log(R+1) - ms*log(ct) - sum(log(Ts)) - sum(log(n))
  }
  return(log_dens)
}

# join likelihood
f.joint <- function(x,lambda,mu){
  tm = x$brts
  M = (ncol(tm)-1)/2
  ans<-NULL
  pars = c(lambda,mu,9e+99)
  if (is.vector(tm)){
    tm<-matrix(tm,nrow=1)
  }
  for (i in 1:nrow(tm)){
    wt = no.na(diff(c(0,x$brts[i,])))
    to = no.na(x$to[i,])
    t.ext = no.na(x$t.ext[i,])
    e = (to==1 & t.ext < 9e+8) # speciation of missing species
    if(length(wt) == length(to)) to = to[-length(to)]
    tot = to
    to[to==2] = 1
    n = c(2,2+cumsum(to)+cumsum(to-1))
    mu = pars[2]
    lambda = lambda.dd(pars,n)
    rho = pmax(lambda[-length(lambda)]*to+mu*(1-to),0)
    sigma = (lambda + mu)*n
    sigma[n==2] = lambda[n==2]*2
    if(sum(to)>=M){
      stopspec = min(which(cumsum(to)==M))
      sigma[(stopspec+1):length(sigma)] = mu*n[(stopspec+1):length(sigma)]
      if(sum(1-to)==M){
        sigma = sigma[-length(sigma)]
        wt = wt[-length(wt)]
      }
    }
    ans[i] = sum(-sigma*wt)+sum(log(rho))
  }
  return(ans)
}
no.na <- function(vector){
  vector[!is.na(vector)]
}

```

### Experiment 

```{r, exp1}
n.sim = 4
lambda = 1
mu = 0.3
CT = 2
M = 2

#x.obs<-observe(x)
x.obs <- matrix(nrow=2,ncol=(2*M+1))
x.obs[,1] = CT

f.hat<-NULL
n.sim <- nrow(x.obs)
n.gsim = 10000
for (i in 1:n.sim){
  x.ext<-g.sim(x.obs[i,],n=n.gsim,M=M)
  f.hat[i] <- mean(exp(f.joint(x.ext,lambda=lambda,mu=mu)-g(x.ext,M)))
}
f.true<-f.marg2S(CT,lambda,mu)
cbind(f.true,f.hat)

```

```{r, vmu}
#consider varying mu 
n.sim = 25
lambda = 1
mu = 0.3
CT = 2
M = 2

#x.obs<-observe(x)
x.obs <- matrix(nrow=2,ncol=(2*M+1))
x.obs[,1] = CT
mu <- seq(0.01,0.99,length=n.sim)

f.hat<-NULL
f.true = NULL
n.gsim = 10000
for (i in 1:n.sim){
  x.ext<-g.sim(x.obs[1,],n=n.gsim,M=M)
  f.hat[i] <- mean(exp(f.joint(x.ext,lambda=lambda,mu=mu[i])-g(x.ext,M)))
  f.true[i] <- f.marg2S(CT,lambda,mu[i])
}
```

```{r}
plot(mu,f.true,ylim=c(min(f.true,f.hat),max(f.true,f.hat)),type="l")
points(mu,f.hat,col="blue")
```
