---
title: "18Sept2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE)
library(emphasis)
library(matrixStats)
```

#### Non Homogenous Poisson Processes (NHPP) 

A NHPP is defined as a Possion process with non constant rates. Thus, given a rate $\lambda(t)$ and defining the intensity function $\Lambda(t) = \int_0^t \lambda(s) ds$, the waiting time for an event to ocuurs has an exponential distribution density 

$$ f(t) = \lambda(t)e^{-\Lambda(t)} $$

and the number of events expected on an interval $[0,T]$ has a poisson distribution density 

$$ P(n) = \frac{\Lambda(t)^n e^{\Lambda(t)}}{n!} $$


##### Species diversification as two separated processes that influences each other 


The process of generating missing species is driven by a NHPP with rate 

$$ m(t) = \lambda_t(1-e^{-\mu_0(T-t)}) $$

where the process of generating observed (extant at the present) species would be a NHPP with rate 

$$ r(t) = \lambda_t e^{-\mu_0 (T-t)} $$
if we assume that $\lambda_t=\sigma_i$ is constant for $t \in [t_{i},t_{i+1}]$, the intensity functions would be 

$$ M(t) = \sigma_i\left[t-\frac{e^{-T\mu_0}}{\mu_0}(e^{t\mu_0}-1)\right], \qquad R(t) = \sigma_i\frac{e^{-T\mu_0}}{\mu_0}(e^{t\mu_0}-1)$$

respectivelly. In order to get the complete likelihood of a tree we also consider extinction processes, so far we assume $\mu_t$ to be constant, so the extinction processes are just homogenous exponentials. Considering also the topologyu of the tree, the whole likelihood would be the combination of this 4 processes 

 \begin{equation} \label{lik2} f_X(x;\phi) = \underbrace{\left(\prod_{i=1}^{d} e^{-\sigma_i\left[\Delta t_i-\frac{e^{-T\mu_0}}{\mu_0}  e^{\Delta t_i \mu_0}-1)\right]}\right)}_\text{missing speciations}\underbrace{\left(\prod_{i=1}^{d} e^{-\sigma_i\frac{e^{-T \mu_0}}{\mu_0}(e^{\Delta t_i \mu_0}-1)} \right)}_\text{extant speciations}\underbrace{\left(\prod_{i=1}^{d} e^{-n_t\mu_0\Delta t_i}\right)}_\text{extinctions}\underbrace{\left( \prod_{i=1}^{d-1} \rho_i \right)}_\text{topology} \end{equation}
 
 Note that after some algebra, this equation is exactly the same than equation (1) of the [Methodology document](https://github.com/franciscorichter/emphasis/blob/master/Methodology.pdf). 
 
 If we conseder the process when topology is not taken into account, we re-define 
 
 \[\rho_i= \begin{cases} 
      n_{t_i} \lambda_i & \text{if speciation at time } t_i \\
      n_{t_i} \mu_i & \text{if extinction at time } t_i
   \end{cases}
\]


and equation \ref{lik2} still holds. 


#### Analysis of number of missing species (dimension of the tree)


To check if the number of species generated by the data augmentation algorithm is consistent with the corresponding sampling distribution we can observe at the NHPP corresponding to missing speciations. Because the rate of this process is a function of the proccess itself we do not know it as the whole process is unknown too. Using the Monte-Carlo ideas, we instead uses an approximated rate function.

If the Monte-Carlo sample $x_1,...,x_m$ correspond to a set of complete trees, each tree $x_i$ has an unique rate function $\lambda_i(t)$, and we assume 


$$ \lambda(t) = \frac{1}{m}\sum_{i=1}^m \lambda_i(t) $$


We then observe this rate and the corresponding empirical histograms


```{r, dim}


poiss_prob <- function(n,tree,pars){
  tree = df2tree(df,pars)
  int = tree$s*(tree$wt-(exp(-tree$r*pars[2])/pars[2])*(exp(tree$wt*pars[2])-1))
  int = sum(int)
  prob = (int^n)*exp(-int)/factorial(n)
  return(prob)
}

btdd = 10:1
pars = c(1,0.1,30)
s = sim.sct(btdd,pars,m=100000,print = F)

dimset = (sort(unique(s$dim))-length(btdd))/2

tr = s$trees
sdf = NULL
for(i in 1:length(tr)){
  tree = tr[[i]]
  int = tree$s*(tree$wt-(exp(-tree$r*pars[2])/pars[2])*(exp(tree$wt*pars[2])-1))
  int = sum(int)
  vals = dpois(dimset,lambda = int)
  sdf = cbind(sdf,vals)
}

means = rowMeans(sdf)
medians = rowMedians(sdf)
miss = (s$dim-length(btdd))/2
hist(miss,prob=TRUE,breaks=50)
lines(dimset,means)
lines(dimset,medians)

```

