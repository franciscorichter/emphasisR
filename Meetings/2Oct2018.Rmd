---
title: "2Oct2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
library(emphasis)
```

### On the discretization of the time component of the SDP


$i = 1,...,n_t$ : Number of species present at time $t$

$T_i \sim Geom(p_1)$ event time 

At $\min \{ T_1,...,T_{n_t} \}$ events occur to those species with that event time 

$E_i \sim Bern(p_2)$

If $E_i = 1$ then speciation
   $E_i = 0$ then extinction 
   
   $$ L(x|p_1 p_2) = \prod_{i=1}^n (1-p_1)^{(t_i-1)n_{t_i}}(1-p_1)^{n_{t_i}-\sum |e_{t_i}|}p_1^{\sum|e_{t_i}|} p_2^{\sum 1\{e_{t_i=1}\}}(1-p_2)^{\sum 1 \{e_{t_i}=0\}}$$
 



a simulation algorithm:

```{r}
sim.discrete <- function(pars=c(0.1,0.9),ct=40){
  p1 = pars[1]
  p2 = pars[2]
  ns = 2 # number of species 
  cbt = 0
  wt = NULL
  tos = NULL
  toe = NULL
  passct = FALSE
  while(ns>0 & !passct){
    nt = rgeom(ns,prob=p1)+1
    nextime = min(nt)
    cbt = cbt + nextime
    if(cbt>ct){
      passct = TRUE
    } 
    if(passct) break
    ne = length(nt[nt==nextime]) # number of events
    se = rbinom(ne,size=1,prob = p2) # speciation or extinction 
    ns = ns + sum(se) - sum(1-se)
    wt = c(wt,nextime)
    tos = c(tos,sum(se)) # topology counting speciations
    toe = c(toe,sum(1-se))
  }
  return(list(wt=wt,tos=tos,tes=toe,passct=passct))
}

nllik.dis <- function(pars,tree){
  tos = tree$tos
  tes = tree$tes
  tau = tos+tes
  n = c(2,2+cumsum(tos)-cumsum(tes))
  n = n[-length(n)]
  p1=pars[1]
  p2=pars[2]
  if(max(pars)>1 | min(pars)<0){ 
    llik = -Inf
  }else{
    llik = sum((tree$wt-1-1)*n*log(1-p1)+(n-tos)*log(1-p1)+tos*log(p1)+tos*log(p2)+tes*log(1-p2))
  }
  return(-llik)
}

mle.discrete <- function(tree,init_par = c(0.5,0.5)){
  po = subplex(par = init_par, fn = nllik.dis, tree = tree,hessian = TRUE)
  return(po)
}

```


```{r, discrete}

tree = sim.discrete(pars=c(0.01,0.8),ct=500)
tree
mle.discrete(tree)
```
 


### Analysis of results varying $m$... with and withouth topology 

```{r}
btdd = c(4.9999999998,4.806886544,4.70731246478,4.50735197578,4.37856240588,4.29594855558,4.19207515688,4.18261061218,4.11238451758,4.09640902445,3.81723693538,3.71143733895,3.48845298905,3.25729503338,3.11613886835,2.64829864145,2.63531839038,2.37990087748,1.82721570435,0.83704715535,0.64242044758,0.56121103655,0.356333544350001,0.346462849050001)
DDD = DDD::dd_ML(brts = btdd, idparsopt = 1:3)
mle_pars = c(DDD$lambda,DDD$mu,DDD$K)
```

with topology

```{r, l1t}
time = proc.time()
S = sim.sct(brts = btdd,pars = mle_pars,m = 100000)
get.time(time)
qplot(S$dim, geom="histogram",binwidth=1)
```

mle

```{r, submlet}
best = c(10000,1000,100,10,1)
times = NULL
MLE = matrix(nrow = 5,ncol = 3)
for(i in 1:5){
  newS = sub.st(S,ntrees = best[i])
  time = proc.time()
  MLE[i,] = mle.st(newS)$par
  times[i] = get.time(time)
}
qplot(1:5,MLE[,2])
times
MLE
```

 without topology

```{r, l1}
time = proc.time()
S = sim.sct(brts = btdd,pars = mle_pars,m = 100000,topology = FALSE)
get.time(time)
qplot(S$dim, geom="histogram",binwidth=1)
```

mle

```{r, submle}
best = c(10000,1000,100,10,1)
times = NULL
MLE = matrix(nrow = 5,ncol = 3)
for(i in 1:5){
  newS = sub.st(S,ntrees = best[i])
  time = proc.time()
  MLE[i,] = mle.st(newS,topology = FALSE)$par
  times[i] = get.time(time)
}
qplot(1:5,MLE[,2])
times
MLE
```


Now with 1 million trees: 


```{r, 1M, eval=FALSE}
load("~/Google Drive/emphasis/1Mtrees.RData")
best = c(10000,1000,100,10,1)
times = NULL
MLE = matrix(nrow = 5,ncol = 3)
for(i in 1:5){
  newS = sub.st(St,ntrees = best[i])
  time = proc.time()
  MLE[i,] = mle.st(newS)$par
  times[i] = get.time(time)
}
qplot(1:5,MLE[,2])
times
MLE
```

