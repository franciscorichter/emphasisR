---
title: "9,Oct,2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(emphasis)
```



```{r}
f.joint1 <- function(tm,lambda,mu,CT=2){
  ans <- NULL
  for (i in 1:nrow(tm)){
    if (tm[i,1] == CT){
      ans[i] = exp(-2*lambda*CT)
    } else {
      if (tm[i,2] == CT){
        ans[i] = dexp(tm[i,1],2*lambda)*(1/2)*pexp(CT-tm[i,1],3*mu,lower.tail=F)
      } else {
        ans[i] = dexp(tm[i,1],2*lambda)*(1/2)*(exp(-(tm[i,2]-tm[i,1])*3*mu))*mu
      }
    }
  }
  return(log(ans))
}

f.joint <- function(x,lambda,mu){
  tm = x$brts
  M = (ncol(tm)-1)/2
  ans<-NULL
  pars = c(lambda,mu,9e+99)
  if (is.vector(tm)){
    tm<-matrix(tm,nrow=1)
  }
  for (i in 1:nrow(tm)){
    wt = no.na(diff(c(0,x$brts[i,])))
    to = no.na(x$to[i,])
    t.ext = no.na(x$t.ext[i,])
    e = (to==1 & t.ext < 9e+8)
    if(length(wt) == length(to)) to = to[-length(to)]
    tot = to
    to[to==2] = 1
    n = c(2,2+cumsum(to)+cumsum(to-1))
    mu = pars[2]
    lambda = lambda.dd(pars,n)
    rho = pmax(lambda[-length(lambda)]*to+mu*(1-to),0)
    sigma = (lambda + mu)*n
    sigma[n==2] = lambda[n==2]*2
    if(sum(tot)>=M){
      stopspec = min(which(cumsum(to)==M))
      sigma[(stopspec+1):length(sigma)] = mu*n[(stopspec+1):length(sigma)]
      if(sum(1-to)==M){
        sigma = sigma[-length(sigma)]
        wt = wt[-length(wt)]
      }
    }
    ans[i] = sum(-sigma*wt)+sum(log(rho))
  }
  return(ans)
}

f.marg <- function(tm,lambda,mu){
  ans<-NULL
  if (is.vector(tm)){
    tm<-matrix(tm,nrow=1)
  }
  CT = no.na(tm[1,])[length(no.na(tm[1,]))]
  for (i in 1:nrow(tm)){
    if (tm[i,1] == CT){
      if (3*mu==2*lambda){
        ans[i] = 1 - 2*CT*lambda*exp(-3*mu*CT)
      } else {
        ans[i] = 1 + ((2*lambda*exp(-3*mu*CT))/(3*mu-2*lambda))*(1-exp(CT*(3*mu-2*lambda)))
      }
    } else {
      ans[i] = dexp(tm[i,1],2*lambda)*(1/2)*(exp(-(tm[i,2]-tm[i,1])*3*mu))
    }
  }
  return(ans)
}

g1 <- function(ta,to,CT){
  ans<-NULL
  n<-nrow(ta)
  if (is.vector(to)){
    to<-matrix(rep(to,each=n),ncol=2)
  }
  for (i in 1:n){
    if (!is.na(to[i,2])){
      ans[i] = 1
    } else {
      if (ta[i,1]==CT){
        ans[i]=0.5
      } else {
        ans[i] = 0.5*dunif(ta[i,1],min=0,max = CT)*dunif(ta[i,2],min=ta[i,1],max = CT)/6
      }
    }
  }
  return(ans)
}

g <- function(x,M){
  ans<-NULL
  n<-nrow(x$brts)
  for (i in 1:n){
    df = data.frame(bt=no.na(x$brts[i,]),bte=no.na(x$t.ext[i,]),to=no.na(x$to[i,]),t.ext=no.na(x$t.ext[i,])-no.na(x$brts[i,]))
    ans[i] = g_samp(df,M)
  }
  return(ans)
}

g_samp <- function(df,M){
  last = dim(df)[1]
  ct = df[last,1]
  Ng = sum(df$to==2) - 1 # number of observed speciations (or given data)
  R = M - Ng
  subdf = df[df$to==1,]
  ms = dim(subdf)[1]
  Ts = ct-subdf$bt
  tempto = df$to
  to = df$to[-last]
  to[to==2] = 1
  n = c(2,2+cumsum(to)+cumsum(to-1))
  n = n[tempto==1 | tempto==0]
  if(R==0){
    log_dens = 0
  }else{
    log_dens = - log(R+1) - ms*log(ct) - sum(log(Ts)) - sum(log(n))
  }
  return(log_dens)
}

sim.extinct.truncdim <- function(brts,M){
  brts = no.na(brts)
  R = M - (length(brts)-1) # maximum possible number of extinctions
  Ne = sample((0:R),1)
  ms = runif(Ne,min=0,max=brts[1])
  me = runif(Ne,min=ms,max=brts[1])
  to = c(rep(1,Ne),rep(0,Ne))
  df = data.frame(bt = c(ms,me),bte=c(me,rep(Inf,Ne)),to=to)
  df = rbind(df,data.frame(bt=brts,to=rep(2,length(brts)),bte=rep(Inf,length(brts))))
  df = df[order(df$bt),]
  df$t.ext = df$bte-df$bt
  return(df)
}

no.na <- function(vector){
  vector[!is.na(vector)]
}


g.sim1<-function(to,n=NULL,CT=2){
  if (is.vector(to)){
    to<-matrix(rep(to,each=n),ncol=2)
  } else {
    n<-nrow(to)
  }
  ta<-matrix(NA,nrow=n,ncol=3)
  for (i in 1:n){
    if (is.na(to[i,2])){
      if (rbinom(1,1,.5)==1){
        u<-runif(2,min=0,max=CT)
        ta[i,1] = min(u)
        ta[i,2] = max(u)
        ta[i,3] = CT
      } else {
        ta[i,1] = CT
      }
    } else {
      ta[i,1:2] = to[i,]
    }
  }
  return(ta)
}


g.sim <- function(x.obs,n=NULL,M){
  if (is.vector(x.obs)){
    x.obs <- matrix(rep(x.obs,each=n),ncol=length(x.obs))
  }
  n <- nrow(x.obs)
  brts <- matrix(nrow=n,ncol=2*M+1)
  to <- matrix(nrow=n,ncol=2*M+1)
  t.ext <- matrix(nrow=n,ncol=2*M+1)
  for (i in 1:n){
    wt = no.na(diff(c(0,x.obs[i,])))
    cs = length(wt)-1 # current speciations
    pm = M - cs  # possible speciations
    if(pm > 0 ){
      df = sim.extinct.truncdim(cumsum(wt),pm)
      brts[i,1:length(df$bt)] = df$bt
      to[i,1:length(df$to)] = df$to
      t.ext[i,1:length(df$to)] = df$t.ext
    }else{
      brts[i,1:length(wt)] = cumsum(wt)
      to[i,1:(length(wt))] = c(rep(2,(length(wt)-1)),2)
      t.ext[i,1:(length(wt))] = c(rep(Inf,(length(wt)-1)),Inf)
    }
  }
  return(list(brts=brts,to=to,t.ext=t.ext))
}

f.sim1 <- function(n,lambda,mu,CT=2){
  tm<-matrix(NA,ncol=3,nrow=n)
  for (i in 1:n){
    t1<-rexp(1,lambda)
    if (t1>CT){
      tm[i,1] = CT
    } else {
      t2<-rexp(1,2*mu)
      if (t2+t1>CT){
        tm[i,1] = t1
        tm[i,2] = CT
      } else{
        tm[i,1] = t1
        tm[i,2] = t2
        tm[i,3] = CT
      }
    }
  }
  return(tm)
}

f.sim <- function(n,lambda,mu,CT=2,M){
  TO <- matrix(NA,ncol=2*M+1,nrow=n)
  BRTS <- matrix(NA,ncol=2*M+1,nrow=n)
  T.EXT <- matrix(NA,ncol=2*M+1,nrow=n)
  for (i in 1:n){
    bt = 0
    N = 2
    to = NULL
    brts = NULL
    ns = ne = 0
    t.ext = NULL
    while(bt < CT & ns < M & N > 1){
      time <- rexp(1,N*(lambda+mu))
      bt = bt + time
      to1 = rbinom(1,1,lambda/(lambda+mu))
      if (to1 == 1) {
        N = N + 1
        ns = ns + 1
      } else {
        N = N-1
        ne = ne +1
        if(N>1) t.ext[sample((1:length(t.ext))[t.ext==Inf & to==1],1)] = bt
      }
      t.ext = c(t.ext,Inf)
      brts = c(brts,bt)
      to = c(to,to1)
    }
    while(bt < CT & ne < M & N > 1){
      time <- rexp(1,N*mu)
      bt = bt + time
      if(bt < CT){
        to = c(to,0)
        t.ext = c(t.ext,Inf)
        brts = c(brts,bt)
      }
      N = N-1
      ne = ne+1
      if(bt<CT & N>1) t.ext[sample((1:length(t.ext))[t.ext==Inf & to==1],1)] = bt
    }
    brts=c(brts,CT)
    t.ext = c(t.ext,Inf)
    to = c(to,2)
    BRTS[i,1:length(brts)] = brts
    TO[i,1:length(to)] = to
    T.EXT[i,1:length(to)] = t.ext
  }
  return(list(brts=BRTS,to=TO,t.ext=T.EXT))
}


observe <- function(x){
  tm = x$brts
  ta<-matrix(nrow=nrow(tm),ncol=ncol(tm)-1)
  for(i in 1:nrow(tm)){
    to = x$to[i,]
    to = to[!is.na(to)]
    t.ext = x$t.ext[i,]
    t.ext = t.ext[!is.na(t.ext)]
    brts = x$brts[i,]
    brts = brts[!is.na(brts)]
    obs = c(brts[c((to==1 & t.ext == Inf),F)],brts[length(brts)])
    ta[i,1:length(obs)] = obs
  }
  return(ta)
}

rm_ext <- function(x){
  rm = (x$to[,1] == 0)
  x$brts = x$brts[!rm,]
  x$to = x$to[!rm,]
  x$t.ext = x$t.ext[!rm,]
  return(x)
}


```


## The K-time-tree space 

### Testing if it works for K = 1

```{r}
# TESTING FUNCTIONS
#sampling
n.sim = 4
lambda = 1
mu = 0.3
CT = 2
M = 1
x<-f.sim(n.sim,lambda = lambda, mu=mu, CT=CT,M = M)
x = rm_ext(x)
x
tm = x$brts[x$to[,1]==1,]
tm

# should match
f.joint(x,lambda = lambda, mu=mu)
f.joint1(tm,lambda,mu)

x.obs<-observe(x)
x.obs

x.ext<-g.sim(x.obs,M=M)
x.ext

g.sim(x.obs[1,],n=6,M = M)

exp(g(x.ext,M))
g1(x.ext$brts,x.obs,CT=CT)
```
