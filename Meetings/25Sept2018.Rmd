---
title: "25Sept2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
library(emphasis)
```

### Considering and not considering topology 

We are interested on see what is the impact of considering or not considering topology on the emphasis approach 


 \begin{equation} \label{lik2} f_X(x,y;\phi) = \underbrace{\left(\prod_{i=1}^{d} e^{-s_i\left[\Delta t_i-\frac{e^{-T\mu_0}}{\mu_0} (e^{\Delta t_i \mu_0}-1)\right]}\right)}_\text{missing speciations}\underbrace{\left(\prod_{i=1}^{d} e^{-s_i\frac{e^{-T \mu_0}}{\mu_0}(e^{\Delta t_i \mu_0}-1)} \right)}_\text{extant speciations}\underbrace{\left(\prod_{i=1}^{m} e^{-\mu_0 t_{i}^{(ext)}}\right)}_\text{extinctions}\underbrace{\left( \prod_{i=1}^{d-1} \rho_i \right)}_\text{topology} \end{equation}
 
 where 
 
  \[\rho_i= \begin{cases} 
       \lambda_{j} & \text{if speciation of species j takes place at time } t_i \\
      \mu_{0} & \text{if extinction of species j takes place at time } t_i
   \end{cases}
\]
 
 the probability density of the missing part of the tree would be then  
 
 
 \begin{equation} \label{sak2} g_X(x;\phi) = \underbrace{\left(\prod_{i=1}^{d} e^{-s_i\left[\Delta t_i-\frac{e^{-T\mu_0}}{\mu_0} ( e^{\Delta t_i \mu_0}-1)\right]}\right)}_\text{missing speciations}\underbrace{\left(\prod_{i=1}^{m} e^{-\mu_0 t_{i}^{(ext)} }\right)}_\text{extinctions}\underbrace{\left( \prod_{i=1}^{2m} \rho_{(m_i)} \right)}_\text{missing topology} \end{equation}
 
 We define 
 
 $$ w_i = \frac{f_{X,Y}(x,y;\phi)}{g_X(x;\phi)} =  \left(\prod_{i=1}^{d} e^{-s_i\frac{e^{-T \mu_0}}{\mu_0}(e^{\Delta t_i \mu_0}-1)} \right)\left( \prod_{i \neq M} \lambda_i \right)$$
 
 where $M = \{m_1, ... , m_m\}$
 
 Empirically, we use the case of Dendroica data and it corresponding MLE. Then on top of that tree we simulate missing data and observe the distribution of weights in relationship with the dimension of the trees. 
 
 
```{r}
#dendroica
btdd = c(4.9999999998,4.806886544,4.70731246478,4.50735197578,4.37856240588,4.29594855558,4.19207515688,4.18261061218,4.11238451758,4.09640902445,3.81723693538,3.71143733895,3.48845298905,3.25729503338,3.11613886835,2.64829864145,2.63531839038,2.37990087748,1.82721570435,0.83704715535,0.64242044758,0.56121103655,0.356333544350001,0.346462849050001)
DDD = DDD::dd_ML(brts = btdd, idparsopt = 1:3)
mle_pars = c(DDD$lambda,DDD$mu,DDD$K)
S = sim.sct(brts = btdd,pars = mle_pars,m = 2000)
qplot(S$dim, geom="histogram",binwidth=1)
mle.st(S)$par
```


On the case of not considering topology the corresponding functions would be the same 

 \begin{equation} \label{lik52} f_X(x,y;\phi) = \underbrace{\left(\prod_{i=1}^{d} e^{-s_i\left[\Delta t_i-\frac{e^{-T\mu_0}}{\mu_0} (e^{\Delta t_i \mu_0}-1)\right]}\right)}_\text{missing speciations}\underbrace{\left(\prod_{i=1}^{d} e^{-s_i\frac{e^{-T \mu_0}}{\mu_0}(e^{\Delta t_i \mu_0}-1)} \right)}_\text{extant speciations}\underbrace{\left(\prod_{i=1}^{m} e^{-\mu_0 t_{i}^{(ext)}}\right)}_\text{extinctions}\underbrace{\left( \prod_{i=1}^{d-1} \rho_i \right)}_\text{topology} \end{equation}
 
but with 
 
  \[\rho_i= \begin{cases} 
      s_i & \text{if speciation at time } t_i \\
      \mu_0 & \text{if extinction at time } t_i
   \end{cases}
\]
 
 and the distribution of the missing part 
 
 
 \begin{equation} \label{sak24} g_X(x;\phi) = \underbrace{\left(\prod_{i=1}^{d} e^{-s_i\left[\Delta t_i-\frac{e^{-T\mu_0}}{\mu_0} ( e^{\Delta t_i \mu_0}-1)\right]}\right)}_\text{missing speciations}\underbrace{\left(\prod_{i=1}^{m}\mu_0 e^{-\mu_0\Delta t_i}\right)}_\text{extinctions}\underbrace{\left( \prod_{i=1}^{m} s_{(m_i)} \right)}_\text{topology} \end{equation}

```{r}
S = sim.sct(brts = btdd,pars = mle_pars,m = 2000,topology = FALSE)
```

and mle

```{r}
mle.st(S,topology=FALSE)$par
```

### Is it really possible to optimize directly without EM?

Using the idea of previous meetings: 

$$ L(y | \theta) = \frac{1}{m}\sum_{i=1}^m f(x_i,y|\theta)\frac{1}{g(x_i|y,\theta)} $$

or $L(y|\theta)=\bar{w}$, where $w = (w_1,...,w_m)$ and $w_i = \frac{f(x_i,y|\theta)}{f(x_i,y|\theta)}$. 

we are wondering if we can just optimize directly 

```{r, eval=FALSE}
mc.llik <- function(pars,brts,m){
  S = sim.sct(brts,pars,m,print=FALSE)
  aplli = log(mean(S$w))
  return(aplli)
}

init_par = mle_pars
time = proc.time()
sub = subplex(par = init_par, fn = mc.llik, brts=btdd,m=10)
get.time(time)
print(sub)
```


### Is it first extinction in agreement with the expected sampling probability?

the probability for the first extinction would be defined by 

$$ g(t=t_0) = \mu_0 \int_{0}^{t_0}  \lambda(t) e^{-\Lambda(t)} e^{-\mu_0 (t_0-t)} dt $$

on the case of DD

$$ g(t=t_0) = \mu_0  \int_{0}^{t_0} s(1-e^{-\mu_0 t}) e^{-s\left[t-\frac{e^{-T\mu_0}}{\mu_0}(e^{\mu_0 t}-1)\right]-\mu_0(t_0-t)} dt$$ 

which is difficult to calculate analitically, so numerical calculations are needed 


```{r}
g_ext <- function(mu,s,text,Ti){
  gvec = NULL
  for(i in 1:length(text)){
    integrand <- function(t) mu*s*(1-exp(-mu*t))*exp(-s*(t-exp(-Ti*mu)*(exp(mu*t)-1)/mu)-mu*(text[i]-t))
    gvec = c(gvec,integrate(f = integrand,lower = 0,upper = text[i])$value)
  }
  return(gvec)
}

btdd = 10
pars = c(1,0.1,10)
time = seq(0,btdd[1],by=0.1)
g = g_ext(text=time,mu=pars[2],Ti=btdd[1],s=2*(pars[1]-(pars[1]-pars[2])*2/pars[3]))#/(1-prob)
S = sim.sct(btdd,pars,10000,print=FALSE)
hist(S$fe,prob=TRUE,breaks = 80)
lines(time,g)
```


### some first steps on making the emphasis framework discrete 


On the discrete case, the waiting times probability density is 

$$ f(x,y;\theta)  = \prod_i^d(1-p_i)^{\Delta t_i-1}p_i \tau_i  $$

