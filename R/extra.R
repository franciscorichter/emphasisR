###DATA

brts_anolis = c(103.31057277, 97.96837055, 94.923127866, 94.866216796, 90.810203432, 
                90.44410561, 90.080885176, 86.938065219, 83.192481566, 79.903508082, 
                78.144291981, 75.916079896, 75.270062039, 74.19732113, 72.825735377, 
                72.5234868711, 68.360444962, 64.1335159681, 63.557121926, 63.523319671, 
                63.398403586, 60.3209181541, 59.490443993, 57.576137962, 56.933279789, 
                56.6964480574, 56.361043545, 55.506578472, 54.495983232, 54.199692129, 
                54.051109589, 53.692672898, 52.897212802, 52.23186871, 52.164805405, 
                51.94779018, 50.553819579, 48.373129976, 47.4174457904, 47.189946167, 
                46.7942740811, 44.287638517, 43.296282982, 43.242616701, 42.272773859, 
                42.1266648041, 41.905974158, 41.329061036, 41.1257958974, 39.697767108, 
                39.677765636, 39.397083778, 37.911582502, 37.397487349, 34.605557178, 
                32.824929892, 32.228763421, 31.561908554, 30.308206955, 30.281651159, 
                30.1639183904, 29.8042173411, 29.773786118, 29.6447104204, 29.541373926, 
                29.5407793691, 28.623740578, 28.506256108, 27.105138539, 26.439039467, 
                26.378922306, 26.285718299, 26.233564599, 24.159222149, 22.974342026, 
                21.370573573, 21.247374251, 20.091077714, 19.6384466391, 19.483057152, 
                18.985702599, 16.272845218, 15.9237660074, 15.8035460904, 15.7840819411, 
                15.2801426021, 15.0803034665, 13.1506065141, 12.572643169, 11.223561248, 
                10.564070149, 10.30031894, 9.651984572, 9.577378633, 9.50317724299997, 
                8.43806557499997, 6.837926447, 5.73566929399999, 5.38425275100001, 
                4.4685701345, 4.33572126899998, 0.828930356499995, 0.552543471999996
)



brts_cetacea = c(35.857845, 33.799004, 32.390661, 31.621529, 28.000001, 26.063017, 
                 26.000001, 24.698215, 22.044392, 19.195664, 18.226421, 18.023412, 
                 17.939427, 17.890656, 16.066686, 15.669702, 15.099325, 14.540283, 
                 14.061555, 13.042869, 12.847396, 11.382959, 11.079292, 11.028304, 
                 10.70277, 10.472235, 9.438013, 8.925942, 8.81602, 8.803019, 8.716039, 
                 8.252102, 8.20904999999999, 8.143058, 8.100266, 7.677423, 7.514394, 
                 7.176679, 6.975185, 6.37563, 6.28945, 6.04702999999999, 5.897506, 
                 5.796585, 5.616381, 5.49323999999999, 5.466433, 5.27807199999999, 
                 5.26532599999999, 5.263495, 5.096383, 4.985876, 4.947171, 4.927157, 
                 4.732447, 4.57089299999999, 4.45271899999999, 4.35571699999999, 
                 4.32202299999999, 4.170967, 4.166225, 4.045704, 3.791853, 3.706276, 
                 3.62611499999999, 3.44535999999999, 3.29116399999999, 3.21256099999999, 
                 3.07916999999999, 3.04867399999999, 2.919779, 2.83297999999999, 
                 2.19441299999999, 2.096219, 1.93481199999999, 1.82123899999999, 
                 1.622022, 1.570433, 1.50673699999999, 1.47078099999999, 1.361358, 
                 1.268114, 1.011163, 0.924861999999997, 0.347030000000004, 0.283069999999995
)

brts_dendroica = c(5, 4.806886544, 4.70731246478, 4.50735197578, 4.37856240588, 
                   4.29594855558, 4.19207515688, 4.18261061218, 4.11238451758, 4.09640902445, 
                   3.81723693538, 3.71143733895, 3.48845298905, 3.25729503338, 3.11613886835, 
                   2.64829864145, 2.63531839038, 2.37990087748, 1.82721570435, 0.83704715535, 
                   0.64242044758, 0.56121103655, 0.356333544350001, 0.346462849050001
)

brts_foraminifera = c(64.95, 64.9, 61.2, 44.15, 37.2, 30.2, 23.8, 22.5, 21, 18.8, 
                      18.3, 17.3, 17, 14.8, 10.8, 10.2, 10, 8.2, 8, 7.2, 5.2, 4.5, 
                      3.8, 3.5, 3.4, 3.2, 2, 2, 0.8, 0.3, 0.3)

brts_heliconius = c(16.761439, 15.160156, 14.40605, 13.815308, 13.486476, 13.164424, 
                    12.373104, 10.840648, 10.142988, 9.911296, 9.273213, 9.264573, 
                    9.142266, 8.536825, 8.441098, 8.17086, 7.92524, 7.478269, 7.255542, 
                    6.851304, 5.335066, 5.335061, 5.152996, 4.643518, 4.506785, 4.446959, 
                    3.780976, 3.768737, 3.488772, 3.398945, 2.433015, 2.048552, 1.930075, 
                    1.602332, 1.302335, 1.033761, 0.884346)

brts_plethodon = c(11.3, 9.55365380008198, 9.26434040327225, 8.83592350352767, 
                   8.3434446982257, 8.17781491491496, 7.95978190384214, 6.61207494082374, 
                   6.5679856688767, 6.21838471981418, 5.59809615547134, 5.37012669852355, 
                   4.7638222125791, 4.10749650972075, 4.02367324807484, 3.65931960175062, 
                   3.329162924011, 3.23132222435799, 3.18206288699248, 2.8572235287017, 
                   2.58222342582278, 2.43078192215161, 1.87377417677032, 1.79734091086791, 
                   1.77566693721338, 1.52675067868777, 1.11116172787207, 0.800771123741394, 
                   0.498973146096477)

brts_vangidae = c(9.77, 9.652180854, 8.612705507, 7.491360279, 4.94075617, 2.5828624
)




# more utilities

number_of_species <- function(tree,tm=NULL){
  initspec = 1
  to = head(tree$to,-1)
  to[to==2] = 1
  n = c(initspec,initspec+cumsum(to)+cumsum(to-1))
  
  
  if(is.null(tm)){
    N=n
  }else{
    if(tm==max(tree$brts)){
      N = n[max(which(c(0,tree$brts) < tm))]
    }else{
      N = n[max(which(c(0,tree$brts) <= tm))]
    }
  }
  return(N)
}

phylodiversity <- function(tm,tree){
  i1<-tree$brts<=tm 
  i2<-tree$to==0&i1
  i3<-tree$t_ext%in%tree$brts[i2]
  dt<-diff(c(0,tree$brts[i1&!i2&!i3],tm))
  return(sum(dt*(1:length(dt))))
}

vectors2phylo <- function(list){
  t=list$wt
  n=list$n
  E=list$E
  S=list$S
  ct=sum(t)
  newick = paste(sl[1],";",sep="")
  N=1
  identf = data.frame(Spec="aa",Time=0) # Labels of species
  for (i in 1:(length(t)-1)){
    # speciation
    sumt = sum(t[1:i])
    if( is.null(S)){
      BD = sample(1:N,1)
      species = as.character(identf[BD,1])
    }else{
      species = S[i]
    }
    if (E[i] == 1){
      ind = regexpr(species,newick)[1]-1
      atm = sumt-identf[which(identf[,1]==species),2]
      newick = paste(substr(newick,1,ind),"(",substr(newick,ind+1,ind+4),",",sl[i+1],"):",as.character(atm),substring(newick,ind+5),sep="")
      identf = rbind(identf,data.frame(Spec=substr(sl[i+1],1,2),Time=sumt))
      identf[identf$Spec == species,2] = sumt
      N = N+1
    }
    # extinction
    if (E[i]==0){
      ind = regexpr(species,newick)[1] + 2
      atm = sumt-identf[which(identf[,1]==species),2]
      identf = identf[!identf$Spec==species,]
      newick = paste(substr(newick,1,ind),as.character(atm),substring(newick,ind+2),sep="")
      N=N-1
    }
  }
  newick = compphyl(newi=newick,identf=identf,ct=ct)
  newick = read.tree(text=newick)
  return(newick)
}



phylo2tree <- function(tree){
  # to map newick trees into ther xxxx format
  ltt = ltt.plot.coords(tree)
  t = diff(ltt[,1])
  ltt = ltt[-1,]
  n = ltt[,2]
  E = diff(n)
  E[E==-1] = 0
  return(list(wt=t,to=E))
}

tree2phylo <- function(tree,initspec=1){
  wt=-diff(c(0,tree$brts))
  to=tree$to
  to[to==2] = 1
  ct=sum(wt)
  newick = paste(sl[1],";",sep="")
  N=1
  identf = data.frame(Spec="a",Time=0) # Labels of species
  for (i in 1:(length(wt)-1)){
    # speciation
    bt = sum(wt[1:i])
    BD = sample(1:N,1)
    species = as.character(identf[BD,1])  
    if (to[i] == 1){
      ind = regexpr(species,newick)[1]-1
      atm = bt-identf[which(identf[,1]==species),2]
      newick = paste(substr(newick,1,ind),"(",substr(newick,ind+1,ind+4),",",sl[i+1],"):",as.character(atm),substring(newick,ind+5),sep="")
      identf = rbind(identf,data.frame(Spec=substr(sl[i+1],1,2),Time=bt))
      identf[identf$Spec == species,2] = bt
      N = N+1
    }
    # extinction
    if (to[i]==0){
      ind = regexpr(species,newick)[1] + 2
      atm = bt-identf[which(identf[,1]==species),2]
      identf = identf[!identf$Spec==species,]
      newick = paste(substr(newick,1,ind),as.character(atm),substring(newick,ind+2),sep="")
      N=N-1
    }
  }
  newick = compphyl(newi=newick,identf=identf,ct=ct)
  newick = read.tree(text=newick)
  return(newick)
}

compphyl <- function(newi,identf,ct){
  #set to extant species to the present time
  identf[,1] = as.character(identf[,1])
  identf[,2] = ct-identf[,2]
  for(i in 1:length(identf[,1])){
    ind = regexpr(identf[i,1],newi)[1] + 2
    newi = paste(substr(newi,1,ind),as.character(identf[i,2]),substring(newi,ind+2),sep="")
  }
  return(newi)
}

sl = paste(letters[1],letters,":0",sep="")
for (i in 2:26){
  ll = paste(letters[i],letters,":0",sep="")
  sl = c(sl,ll)
}

# time calculation
get.time <- function(time,mode='sec'){
  dif = proc.time()-time
  ti = as.numeric(dif[3])
  if(mode == 'min')  ti = ti/60
  if(mode == 'hou') ti = ti/3600
  return(ti)
}

W <- function (z, branch = 0)
{
  stopifnot(length(branch) == 1, is.numeric(z))
  if (anyNA(z)) {
    warning("Some values of ", deparse(substitute(z)), " are NA or NaN. ",
            "Returning 'NA' for these entries.")
    non.na.z <- z[!is.na(z)]
  }
  else {
    non.na.z <- z
  }
  W.non.na.z <- rep(NA, length(non.na.z))
  if (branch == 0) {
    W.non.na.z <- lamW::lambertW0_C(non.na.z)
  }
  else if (branch == -1) {
    if (any(is.infinite(z))) {
      warning("'Inf' is not a valid argument of the non-principal branch W",
              " (branch = -1).")
    }
    W.non.na.z <- lamW::lambertWm1_C(non.na.z)
  }
  else {
    stop("Branch was ", branch, "; must be either '0' or '-1'.")
  }
  if (length(W.non.na.z) == length(z)) {
    dim(W.non.na.z) <- dim(z)
    return(W.non.na.z)
  }
  else {
    W.z <- rep(NA, length(z))
    W.z[!is.na(z)] <- W.non.na.z
    W.z[is.nan(W.z)] <- NA
    dim(W.z) <- dim(z)
    return(W.z)
  }
}

get.topologies <- function(M){
  if(M == 0)
  {
    return(NULL)
  }
  TO = matrix(nrow=2*M,ncol=1)
  TO[1,1] = 1
  for(i in 2:(2*M)){
    comb = ncol(TO)
    for(j in 1:comb){
      ns = sum(no.na(TO[,j]))
      ne = sum(1-no.na(TO[,j]))
      if(ns < M & ns > ne){ #extinction or speciation
        TO[i,j] = 1
        TO = cbind(TO,matrix(TO[,j],ncol=1))
        TO[i,ncol(TO)] = 0
      }
      if(ns == M & ns > ne){ #extinction
        TO[i,j] = 0
      }
      if(ns < M & ns == ne){ #speciation
        TO[i,j] = 1
      }
    }
  }
  return(TO)
}



sim.tree <- function(pars,CT,seed=1,model="dd"){
  set.seed(seed)
  mu = pars[2]
  N = 2
  brts = 0
  to = c(1,1)
  while(max(brts)<CT & N>0){
    if(model=="dd") lambda = lambda.dd(pars,N)
    if(model=="cr") lambda = lambda.cr(pars,N)
    sigma = N*(mu+lambda)
    wt = rexp(1,rate=sigma)
    tev = rbinom(n=1,size=1,prob= (lambda/(lambda+mu)) )
    brts = c(brts,max(brts)+wt)
    to = c(to,tev)
    if(tev==1) N = N+1
    if(tev==0 & max(brts)<CT){
      N = N-1
      ext = sample((1:length(to))[to==1],1)
      to[ext] = -1
    }
  }
  to = to[-length(to)]
  if(max(brts)>CT) brts[length(brts)]=CT
  tree = list(wt=diff(brts),to=to)
  return(tree)
}

prune.tree <- function(tree){
  brts = sum(tree$wt)-c(0,cumsum(tree$wt))
  brts = c(brts[1],brts[-length(brts)])
  nbrts = brts[tree$to==1]
  return(nbrts)
}

nh_tree_augmentation_dd <- function(observed.branching.times,pars,model="dd",initspec = 1){
  
  b = max(observed.branching.times)
  brts = sort(brts)
  mu = pars[3]
  missing_branches = data.frame(speciation_time=NULL,extinction_time=NULL)
  N = initspec # current number of species
  cbt = 0 # current branching time
  while(cbt < b){
    lambda = lambda.dd(pars,N)
    all_bt = c(observed.branching.times,missing_branches$speciation_time,missing_branches$extinction_time)
    next_bt = min(all_bt[all_bt>cbt])
    next_speciation_time = rnhpp_dd(s=N*lambda,mu=mu,r=b-cbt,cbt=cbt,next_bt=next_bt)
    if(next_speciation_time < next_bt){ # add new species
      extinction_time = next_speciation_time + truncdist::rtrunc(1,"exp",a = 0, b = (b-next_speciation_time),rate=mu)
      missing_branches = rbind(missing_branches,data.frame(speciation_time=next_speciation_time,extinction_time=extinction_time))
      cbt = next_speciation_time
      N = N+1
    }else{
      cbt = next_bt
      if(next_bt %in% missing_branches$extinction_time){
        N = N-1
      }else{
        N = N+1
      }
    }
  }
  df = data.frame(brts = c(missing_branches$speciation_time,observed.branching.times,missing_branches$extinction_time),
                  bte = c(missing_branches$extinction_time, rep(Inf,length(observed.branching.times)+nrow(missing_branches))),
                  to = c(rep(1,nrow(missing_branches)),rep(2,length(observed.branching.times)),rep(0,nrow(missing_branches))))
  df = df[order(df$brts),]
  df$t.ext = df$bte-df$brts
  return(df)
  
}

