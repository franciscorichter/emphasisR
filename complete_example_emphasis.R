###DATA
brts_anolis = c(103.31057277, 97.96837055, 94.923127866, 94.866216796, 90.810203432, 
                90.44410561, 90.080885176, 86.938065219, 83.192481566, 79.903508082, 
                78.144291981, 75.916079896, 75.270062039, 74.19732113, 72.825735377, 
                72.5234868711, 68.360444962, 64.1335159681, 63.557121926, 63.523319671, 
                63.398403586, 60.3209181541, 59.490443993, 57.576137962, 56.933279789, 
                56.6964480574, 56.361043545, 55.506578472, 54.495983232, 54.199692129, 
                54.051109589, 53.692672898, 52.897212802, 52.23186871, 52.164805405, 
                51.94779018, 50.553819579, 48.373129976, 47.4174457904, 47.189946167, 
                46.7942740811, 44.287638517, 43.296282982, 43.242616701, 42.272773859, 
                42.1266648041, 41.905974158, 41.329061036, 41.1257958974, 39.697767108, 
                39.677765636, 39.397083778, 37.911582502, 37.397487349, 34.605557178, 
                32.824929892, 32.228763421, 31.561908554, 30.308206955, 30.281651159, 
                30.1639183904, 29.8042173411, 29.773786118, 29.6447104204, 29.541373926, 
                29.5407793691, 28.623740578, 28.506256108, 27.105138539, 26.439039467, 
                26.378922306, 26.285718299, 26.233564599, 24.159222149, 22.974342026, 
                21.370573573, 21.247374251, 20.091077714, 19.6384466391, 19.483057152, 
                18.985702599, 16.272845218, 15.9237660074, 15.8035460904, 15.7840819411, 
                15.2801426021, 15.0803034665, 13.1506065141, 12.572643169, 11.223561248, 
                10.564070149, 10.30031894, 9.651984572, 9.577378633, 9.50317724299997, 
                8.43806557499997, 6.837926447, 5.73566929399999, 5.38425275100001, 
                4.4685701345, 4.33572126899998, 0.828930356499995, 0.552543471999996
)

mle_anolis = c(0.068759,0.0005709097,0.005940)

brts_cetacea = c(35.857845, 33.799004, 32.390661, 31.621529, 28.000001, 26.063017, 
                 26.000001, 24.698215, 22.044392, 19.195664, 18.226421, 18.023412, 
                 17.939427, 17.890656, 16.066686, 15.669702, 15.099325, 14.540283, 
                 14.061555, 13.042869, 12.847396, 11.382959, 11.079292, 11.028304, 
                 10.70277, 10.472235, 9.438013, 8.925942, 8.81602, 8.803019, 8.716039, 
                 8.252102, 8.20904999999999, 8.143058, 8.100266, 7.677423, 7.514394, 
                 7.176679, 6.975185, 6.37563, 6.28945, 6.04702999999999, 5.897506, 
                 5.796585, 5.616381, 5.49323999999999, 5.466433, 5.27807199999999, 
                 5.26532599999999, 5.263495, 5.096383, 4.985876, 4.947171, 4.927157, 
                 4.732447, 4.57089299999999, 4.45271899999999, 4.35571699999999, 
                 4.32202299999999, 4.170967, 4.166225, 4.045704, 3.791853, 3.706276, 
                 3.62611499999999, 3.44535999999999, 3.29116399999999, 3.21256099999999, 
                 3.07916999999999, 3.04867399999999, 2.919779, 2.83297999999999, 
                 2.19441299999999, 2.096219, 1.93481199999999, 1.82123899999999, 
                 1.622022, 1.570433, 1.50673699999999, 1.47078099999999, 1.361358, 
                 1.268114, 1.011163, 0.924861999999997, 0.347030000000004, 0.283069999999995
)

mle_cetacea = c(0.135271,0.0005749927,0.0005749927)


brts_dendroica = c(5, 4.806886544, 4.70731246478, 4.50735197578, 4.37856240588, 
                   4.29594855558, 4.19207515688, 4.18261061218, 4.11238451758, 4.09640902445, 
                   3.81723693538, 3.71143733895, 3.48845298905, 3.25729503338, 3.11613886835, 
                   2.64829864145, 2.63531839038, 2.37990087748, 1.82721570435, 0.83704715535, 
                   0.64242044758, 0.56121103655, 0.356333544350001, 0.346462849050001
)

mle_dendroica = c(3.659926,0.1479505,0.182003)

brts_foraminifera = c(64.95, 64.9, 61.2, 44.15, 37.2, 30.2, 23.8, 22.5, 21, 18.8, 
                      18.3, 17.3, 17, 14.8, 10.8, 10.2, 10, 8.2, 8, 7.2, 5.2, 4.5, 
                      3.8, 3.5, 3.4, 3.2, 2, 2, 0.8, 0.3, 0.3)

brts_heliconius = c(16.761439, 15.160156, 14.40605, 13.815308, 13.486476, 13.164424, 
                    12.373104, 10.840648, 10.142988, 9.911296, 9.273213, 9.264573, 
                    9.142266, 8.536825, 8.441098, 8.17086, 7.92524, 7.478269, 7.255542, 
                    6.851304, 5.335066, 5.335061, 5.152996, 4.643518, 4.506785, 4.446959, 
                    3.780976, 3.768737, 3.488772, 3.398945, 2.433015, 2.048552, 1.930075, 
                    1.602332, 1.302335, 1.033761, 0.884346)

mle_heliconius = c(0.457300,0.01080816,0.048939)

brts_plethodon = c(11.3, 9.55365380008198, 9.26434040327225, 8.83592350352767, 
                   8.3434446982257, 8.17781491491496, 7.95978190384214, 6.61207494082374, 
                   6.5679856688767, 6.21838471981418, 5.59809615547134, 5.37012669852355, 
                   4.7638222125791, 4.10749650972075, 4.02367324807484, 3.65931960175062, 
                   3.329162924011, 3.23132222435799, 3.18206288699248, 2.8572235287017, 
                   2.58222342582278, 2.43078192215161, 1.87377417677032, 1.79734091086791, 
                   1.77566693721338, 1.52675067868777, 1.11116172787207, 0.800771123741394, 
                   0.498973146096477)

mle_plethodon = c(0.523708,0.01570368,0.025529)
brts_vangidae = c(9.77, 9.652180854, 8.612705507, 7.491360279, 4.94075617, 2.5828624)

# data prepataion
newick="((Orycteropus_afer:93.5553,(Loxodonta_africana:59.821,Dugong_dugon:59.821):33.7343):9.2258,((( Cyclopes_didactylus:38.0246,(Myrmecophaga_tridactyla:12.8339,(Tamandua_mexicana:1.0027,(Tamand ua_tetradactyla_NC:0.1684,Tamandua_tetradactyla:0.1684):0.8342):11.8312):25.1907):20.8529,((Ch oloepus_hoffmanni:9.6461,(Choloepus_didactylus_NC:0.2072,Choloepus_didactylus:0.2072):9.4389): 21.0823,(Bradypus_torquatus:19.635,(Bradypus_pygmaeus:7.9961,(Bradypus_tridactylus:5.9217,(Bra dypus_variegatus:1.1677,Bradypus_variegatus_NC:1.1677):4.754):2.0743):11.6388):11.0935):28.149 1):9.2283,((Dasypus_kappleri:12.9351,((Dasypus_septemcinctus:0.0776,Dasypus_hybridus:0.0776):5 .259,(Dasypus_novemcinctus_FG:3.9067,((Dasypus_yepesi:0.6622,Dasypus_sabanicola:0.6622):2.3934 ,(Dasypus_novemcinctus_NC:2.8906,(Dasypus_pilosus_2:0.3478,Dasypus_pilosus_1:0.3478):2.5427):0 .165):0.851):1.43):7.5984):32.3822,((Euphractus_sexcinctus:10.9399,(Chaetophractus_villosus:9. 0975,(Zaedyus_pichiy:8.2149,(Chaetophractus_vellerosus:0.2264,Chaetophractus_nationi:0.2264):7 .9884):0.8826):1.8424):26.2721,((Chlamyphorus_truncatus:19.4188,Calyptophractus_retusus:19.418 8):13.1925,(Priodontes_maximus:25.7131,((Tolypeutes_tricinctus:14.0698,Tolypeutes_matacus:14.0 698):8.4247,(Cabassous_tatouay:11.0105,(Cabassous_chacoensis:8.6233,(Cabassous_centralis:1.313 ,(Cabassous_unicinctus_2:0.2894,Cabassous_unicinctus_1:0.2894):1.0235):7.3102):2.3871):11.4841 ):3.2184):6.8982):4.6007):8.1053):22.7885):34.6752);"
phy = read.tree(text = newick)
brts=sort(branching.times(phy),decreasing = TRUE)
names(brts)=NULL
brts = brts[brts>1]
ddd = DDD:::dd_ML(brts = brts)


tree = data.frame(brts = brts,to=rep(2,length(brts)),t_ext=rep(Inf,length(brts)))


######### sparate E and m step

pars = c(0.05,0.3,-0.005,NULL)
#pars = c(ppp$mu,ppp$lambda,(ppp$mu-ppp$lambda)/ppp$K,NULL)
input = list(brts=brts,pars=pars,sample_size=100,model="rpd1",cores=2,parallel=TRUE)

n_it = 500
mcem=NULL
for(i in 1:n_it){
  print(paste("iteration",i))
  print(pars)
   
  st = mcE_step(brts = input$brts, pars = pars,sample_size=input$sample_size,model=input$model,no_cores=input$cores,parallel=input$parallel)
  
  M = M_step(st = st, init_par = pars, model = input$model)
  #pp = rbind(pp,data.frame(fhat=log(st$fhat),eitme=st$E_time,ss=input$sample_size))
  AIC = 2*length(pars)-2*log(st$fhat)
  AICc = AIC + (2*length(pars)*length(pars)+2*length(pars))/(input$sample_size-length(pars)-1)
  print(log(st$fhat))
  pars = M$po$par
  mcem = rbind(mcem,data.frame(par1=pars[1],par2=pars[2],par3=pars[3],par4=pars[4],fhat=log(st$fhat),E_time=st$E_time,M_time=M$M_time,sample_size=input$sample_size,AICc=AICc))
}


ggplot(pp) + geom_point(aes(x=ss,y=fhat,colour=ss))+geom_hline(yintercept = ppp$loglik)+geom_hline(yintercept = median(pp$fhat[pp$ss==100]),color='green')+geom_hline(yintercept = median(pp$fhat[pp$ss==1000]),color='blue')+geom_hline(yintercept = median(pp$fhat[pp$ss==500]),color='red')



#### comparing likelihood
dddd = DDD:::dd_ML(brts = brts,cond = 1,soc = 2)

pars = c(dddd$mu,dddd$lambda,(dddd$mu-dddd$lambda)/dddd$K)
input = list(brts=brts,pars=pars,sample_size=300,model="rpd1",cores=2,parallel=TRUE)






pars2 = c(250,1,0,1,1,2)
dd_loglik(pars1=c(pars[2],pars[1],(pars[1]-pars[2])/pars[3]),pars2,brts_heliconius,missnumspec = 0)
###########



#setwd("~/Google Drive/scripts for jobs and data/Experiments/MCEM/Dendroica/rpd5/ss1000")
#setwd("~/Google Drive/scripts for jobs and data/Experiments/MCEM/Anolis/rpd5")
#devtools::install_github("franciscorichter/emphasis")
library(emphasis)
## input 1. Simple tree, Ok initial parameters
l0 = mle_dendroica[1]
ga = mle_dendroica[2]
mu =  mle_dendroica[3]

pars = c(l0,0,mu,ga)
#pars = c(l0,ga,mu)
pars = c(4.016086, -0.005787463, 0.1728389, 0.1651889)


mu0=0.1623; lambda0=3.671; Npar=-0.1559; PDpar=0.082897
pars = c(lambda0, Npar, mu0, PDpar)
input = list(brts=brts_dendroica,pars=pars,sample_size=100,model="rpd5",importance_sampler="emphasis",cores=detectCores(),method="thinning",aceleration_rate=1,parallel=TRUE)
mcem.tree(input,file="den_ss100rpd5_17Jan_mac.RData")

pars = c(1,-0.01,0.1)
input = list(brts=brts_vangidae,pars=pars,sample_size=100,model="rpd2b",importance_sampler="emphasis",cores=detectCores(),method="thinning",aceleration_rate=1,parallel=TRUE,maxnumspec=50)
mcem.tree(input,file="pd_ss100_emphasis.RData")


